# **WFO Portrait Maker 開発ドキュメント**

Version: 5.0.0 (Final: Game Specification Compliant)  
Date: 2025-12-03

# **1\. システム概要 (System Overview)**

## **1.1 目的**

PCゲーム「Wizardry外伝 五つの試練」のユーザーポートレート画像（faceフォルダ配下）を管理・生成するWindowsアプリケーション。  
ユーザーは1枚の立ち絵画像から、ゲーム内で必要な全5種類×全状態の画像を、適切なレイアウトと命名規則で一括自動生成できる。

## **1.2 ターゲット環境**

* **OS:** Windows 10 / 11 (64bit)  
* **実行権限:** 管理者権限（必須 \- Program Files配下への書き込み用）

## **1.3 開発技術スタック**

* **言語:** Python 3.10+  
* **GUI:** CustomTkinter (v5.2.0+) \- Theme: "Dark", "Blue"  
* **Image:** Pillow (v10.0.0+) \- Resampling: LANCZOS  
* **AI:** rembg (v2.0.50+)  
* **D\&D:** tkinterdnd2  
* **Build:** PyInstaller

# **2\. 画面・UI詳細設計 (Screen & UI Specification)**

ウィンドウ初期サイズ: **1200x800** (最小 1024x768)

## **2.1 メイン画面構成**

### **A. キャラクターリスト (Left Panel) \- 幅: 300px**

* **コンポーネント:** CTkScrollableFrame  
* **カード仕様:** 高さ80px。サムネイル(face\_a)、名前、ID(faceXX)、状態アイコンを表示。  
* **操作:**  
  * **選択:** クリック（複数選択可）。  
  * **D\&D (Import):** 外部ファイルを空白部にドロップで一括新規登録。  
  * **D\&D (Merge):** カード同士のドロップで「スマートマージ（状態統合）」起動。  
  * **右クリック:** コンテキストメニュー（削除、フォルダを開く）。  
* **フッター:** \[+ 新規作成\] ボタン。

### **B. 編集パネル (Right Panel) \- 幅: 可変**

#### **B-1. プレビューエリア (Canvas)**

* **表示:** 選択中のキャラクター・状態の画像をアスペクト比維持で表示。  
* **ガイドオーバーレイ (Guide):**  
  * 編集中の状態が face_c (ステータス) か face_d (戦闘) かに応じて、guides.json の定義枠（緑/黄/赤）を半透明表示。スイッチでON/OFF。  
* **表示モード切替 (View Mode):**
  * **Single (通常):** 選択中の1状態を大きく表示し、編集を行うモード。
  * **Grid (一覧):** 全状態 (Normal, Poison, Dead...) のプレビューをタイル状に一覧表示するモード。
    * *用途:* 「Deadだけ顔位置がズレている」などを一目で確認する。
    * *操作:* タイルをクリックすると、その状態を選択して **Singleモード** に遷移し、即座に編集を開始できる。
* **顔位置指定 (Face Center):**  
* **顔位置指定 (Face Center):**  
  * 画像上をクリックすると、その座標を「顔中心」として記録し、赤十字マーカーを表示。  
  * **数値指定:** クリックでの指定に加え、X, Y 座標を数値で微調整できるスピンボックス (Spinbox) を提供。
  * **仕様:** 顔中心 (Face Center) は全状態で共通の「キャンバス上の固定座標」とする。
    * *ユーザーへのガイド:* 「各状態（Normal, Dead等）の画像を移動 (Offset) させて、顔がこの十字の中心に来るように合わせる」というワークフローを推奨。
  * **バリデーション:** 未設定時は画面中央に「顔位置をクリックで設定してください」と警告表示。

#### **B-2. 操作パネル (Controls)**

1. **基本情報:** 名前編集、状態切替（Normal, Poison, Dead...）。  
2. **画像設定:** 画像変更ボタン、背景除去(AI)スイッチ。  
3. **レイアウト:**  
   * スライダー: Scale (0.1~2.0), Pos X, Pos Y。  
   * リセットボタン。  
   * **設定コピー:**
     * [Normalからコピー]: Normal状態の Scale/Pos/Rembg 設定を現在の状態に適用。
     * [全状態に適用]: 現在の設定を全ての状態に適用。
4. **フレーム:** フレーム選択コンボ、D\&Dでの追加登録。  
5. **アクション:**  
   * [保存 (Export)] ボタン（緑色）。  
   * **フィードバック:** 保存処理中は操作をブロックし、プログレスバー付きのダイアログを表示する。
   * **制約:** 顔位置 (face_center) が未設定の場合、ボタンを押しても警告ダイアログを出し、保存処理を実行しない。

### **C. ログエリア (Bottom Panel) - 高さ: 100px**

* **機能:** 実行ログ ([INFO], [ERROR]) を時系列表示。

### **D. フッターエリア (Footer Area)**

* **配置:** ログエリアの上部 (または下部)。
* **コンポーネント:**
  * **[フォルダを開く] ボタン:** `face` フォルダ（全キャラクターの親ディレクトリ）をエクスプローラーで開く。
  * **言語切替:** アプリの表示言語 (JP/EN) を切り替えるコンボボックス。

# **3\. データ構造定義 (Data Structure)**

## **3.1 project\_data.json**

各 face フォルダ内に保存。

{  
  "version": "1.3",  
  "display\_name": "戦士アレックス",  
  "uuid": "unique-uuid-v4",  
  "face\_center": { "x": 500, "y": 300 }, // 初期値 null (必須)  
  "frame\_id": "frame\_gold.png",  
  "states": {  
    "normal": {  
      "source\_uuid": "img-uuid-1",  
      "scale": 1.0,  
      "offset\_x": 0,  
      "offset\_y": 0,  
      "use\_rembg": false  
    },  
    "poison": {  
      "source\_uuid": "img-uuid-2",  
      "scale": 1.0,  
      "offset\_x": 0,  
      "offset\_y": 0,  
      "use\_rembg": true  
    }  
  }  
}

## **3.2 出力ファイル名サフィックス定義 (Suffix Definition)**

ゲーム仕様に基づく固定ルール。**開発者はこの対応表を厳守すること。**

| State Key (内部用) | Suffix (ファイル名末尾) | 優先度 | 備考 |
| :---- | :---- | :---- | :---- |
| normal | (なし) | 1 | 必須 |
| hp\_75 | \_75 | 2 | HP 50-75% |
| hp\_50 | \_50 | 3 | HP 26-49% |
| hp\_25 | \_25 | 4 | HP 1-25% |
| dead | \_DE | 5 | 死亡 |
| poison | \_PO | 6 | 毒 |
| afraid | \_AF | 7 | 恐怖 |
| sleep | \_SL | 8 | 睡眠 |
| paralyzed | \_PA | 9 | 麻痺 |
| stoned | \_ST | 10 | 石化 |
| ashed | _AS | 11 | 灰 |

## **3.3 app_config.json**

アプリケーションのルートディレクトリに保存。

{
  "language": "JP",
  "window_geometry": "1200x800",
  "last_open_path": "C:/Path/To/Wizardry/Data/User/face"
}

# **4\. 機能要件・ロジック詳細**

## **4.1 パス解決とスロット管理**

1. **パス検知:** SteamFinder で Wizardry The Five Ordeals を検索。失敗時は WizardryFoV2.exe を指定させ、Data/User/face を特定。  
2. **スロット確保:** 新規作成時、face1 ～ face100 のフォルダを走査し、欠番（空き）を自動使用。

## **4.2 画像インポート & スマートマージ**

* **インポート:** 画像を faceXX/sources/ にUUIDリネームして保存。  
* **スマートマージ:** D&D時に「どの状態（Poison等）として取り込むか」を選択させ、対象のStateデータとして保存する。

## **4.3 編集・調整フロー (Review & Tweak)**

1.  **一括確認:** プレビューを **Gridモード** に切り替え、全状態の生成結果（顔位置のズレなど）を俯瞰する。
2.  **個別修正:** 問題のある状態（例: イラストが異なるDead状態など）をクリックして **Singleモード** へ移動。
3.  **調整:** スピンボックスやドラッグ操作で Offset/Scale を調整し、顔を十字ガイドに合わせる。
4.  **確認:** 再度 Gridモードに戻るか、そのまま保存する。

## **4.4 保存・出力処理 (Export Logic) - 【最重要】**

ボタン押下時、以下のフローを実行する。

1. **事前チェック:** face\_center が設定されているか確認。未設定なら中断。  
2. **ループ処理:** 定義された全状態（Normal, Poison...）のうち、設定が存在するものについて順次生成。  
3. **画像生成詳細:**  
   * **ベース画像:** 元画像を読み込み、AI除去(任意) \-\> リサイズ \-\> 座標配置 \-\> フレーム合成。  
   * **キャンバスサイズ:** 全て 1920x1080 (RGBA) で作業。  
   * **配置:** デフォルトは右寄せ（face\_cガイド準拠）。ユーザー設定の offset を適用。  
4. ファイル書き出し (1状態につき最大4ファイル):  
   生成したベース画像 (img\_full) から、以下のファイルを生成する。

| ファイル種別 | 解像度 | 生成ルール | ファイル名例 (Poisonの場合) |
| :---- | :---- | :---- | :---- |
| **face\_c** | 1920x1080 | img\_full そのまま保存 | face\_c\_PO.png |
| **face\_d** | 1920x1080 | face\_c と同一 (複製) | face\_d\_PO.png |
| **face\_e** | 1920x1080 | face\_c と同一 (複製) | face\_e\_PO.png |
| **face\_b** | 270x96 | face\_center を中心にクロップ＆リサイズ | face\_b\_PO.png |
| **face\_a** | 96x96 | face\_center を中心にクロップ＆リサイズ | face\_a.png (※注) |

   * **※注:** face\_a (SDアイコン) はゲーム仕様上、状態差分を持つかは不明瞭だが、アプリとしては Normal 状態の時のみ face\_a.png を生成・上書きする仕様とする。face\_b (HDアイコン) は全状態で差分を生成する。  
5. **アトミック保存:**  
   * 一時ファイル (.tmp.png) として出力 → 成功確認 → 古い同名ファイルを削除 → リネーム。  
   * PermissionError (ゲーム起動中) は3回リトライ後、ダイアログ表示。

## **4.4 削除とUndo**

* **対象:**
  * キャラクター削除
  * パラメータ変更 (名前、Scale, Offset, State切替など)
  * 画像インポート
* **操作:** Ctrl+Z で直前の操作を取り消し可能。

## **4.5 ガイド機能**

* guides.json に基づき、プレビューに Safe/Warning/Forbidden ゾーンをオーバーレイ表示。  
* 編集中の状態が戦闘用（Normal以外で戦闘シーンに使われるもの等）かどうかの区別が難しいため、簡易的に **「基本は face\_c (ステータス) 用ガイドを表示し、スイッチで face\_d (戦闘) 用ガイドに切り替え可能」** とする。

## **4.6 多言語対応 (Localization)**

* `assets/locales/` 配下の JSON ファイル (jp.json, en.json) を読み込み、UIのテキストを動的に切り替える。
* 設定は `app_config.json` に保存され、次回起動時に維持される。

## **4.7 アプリ設定保存 (App Configuration)**

* 以下の情報を `app_config.json` に自動保存する。
  * ウィンドウサイズ・位置
  * 選択言語
  * 最後に開いた `face` フォルダのパス

# **5\. エラーメッセージ**

* "顔の中心位置が設定されていません。"  
* "Wizardryのインストール先が見つかりません。"  
* "ファイルを保存できませんでした。ゲームを終了して再試行してください。"

**End of Document**