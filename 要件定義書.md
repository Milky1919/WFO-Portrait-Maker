# WFO Portrait Maker 開発ドキュメント

**Version:** 1.1.0 (Reflected Implementation) **Date:** 2025-12-03

# 1. 要件定義書 (Requirement Specification)

## 1.1 プロジェクト概要

*   **名称:** WFO Portrait Maker
*   **目的:** PCゲーム「Wizardry外伝 五つの試練」用ポートレート画像（`face`フォルダ）の作成・管理・一括編集を効率化する。
*   **ターゲットユーザー:** Mod制作者および一般プレイヤー。
*   **動作環境:** Windows 10/11 (x64)
*   **権限要件:** 管理者権限での実行を必須とする（Program Files等のシステムフォルダへのアクセス保証のため）。

## 1.2 UI/UX 要件

### 1.2.1 メイン画面構成

*   **テーマ設定:** アプリケーションの配色は「Dark」モード、「Blue」テーマを基調とする。

1.  **キャラクターリストエリア (Main/Left)**
    
    *   **表示:** スクロール可能なグリッド表示（カード形式）。
    *   **カード情報:** サムネイル(face\_a)、表示名(Display Name)、登録済み状態アイコン(N, P, D等)、フォルダID(faceX)。
    *   **操作:**
        
        *   **D&D追加:** **単一または複数の**画像ファイルをリストの空白部分へドロップし、新規追加。
        *   **スマートマージ:** カードをドラッグして他のカードに重ね、状態差分として統合。
        *   **複数選択:** `Ctrl` / `Shift` + クリックで複数カードを選択可能。
        *   **コンテキストメニュー:** 右クリックで「削除」等。
        *   **新規作成ボタン:** リスト最下部に「新規キャラクター」ボタンを配置。
2.  **編集パネル (Right)**
    
    *   **プレビュー:** 選択中のキャラクター（複数選択時は最後にクリックした1体）を表示。
    *   **状態切替:** タブまたはリスト形式で状態(Normal, Poison, Dead...)を切り替え。
    *   **パラメータ調整:**
        
        *   **スライダー:** X座標、Y座標、拡大率(Scale)。
        *   **リセットボタン:** 現在の状態の座標・拡大率を初期値に戻す。
    *   **機能スイッチ:**
        
        *   **背景除去 (AI):** ON/OFFトグル（初回ON時にモデルDL確認）。
        *   **フレーム選択:** 登録済みフレームの選択（なし/Gold/Silver等）。
    *   **保存アクション:** 「保存(Export)」ボタン（ショートカット `Ctrl+S` 推奨）。

### 1.3 機能要件詳細

#### 1.3.1 データインポート & 管理

*   **フリーネームD&D:** ユーザーのファイル名（日本語・記号含む）を問わず受け入れる。内部的にはUUIDで管理し、システムエラーを防ぐ。
*   **編集画面D&D:** キャラクター編集画面を開いている状態で画像をドロップした場合、そのキャラクターの状態差分として追加・登録できるダイアログを表示する。
*   **フレーム素材追加:** 編集パネルのフレームエリアへの画像D&Dにより、`assets/frames` へコピー登録する。
*   **Undo機能:** リスト操作（マージ、削除）に対し、最低1段階の `Ctrl+Z` (Undo) を実装する。
*   **スロット自動確保:** 新規作成時、`face1` ～ `face100` の範囲で空いている若い番号のフォルダを自動的に確保する。上限（100）に達している場合は作成できない。

#### 1.3.2 画像編集ロジック

*   **顔位置指定:** プレビュー上のクリックで `face_a`(アイコン) の中心座標を指定。
*   **立ち絵配置:** `face_c`~`e` は「右寄せ」を基準とする。
*   **サイズ自動調整:**
    
    *   高さ1080px超 → アスペクト比維持で縮小。
    *   高さ1080px未満 → 原寸維持（デフォルメキャラ対応）。
*   **一括編集 (Batch Edit):** 複数選択状態でスライダーを操作した場合、**選択された全キャラクター**に対し、その絶対値を適用する。
*   **フレーム合成:** 選択したフレームに対応するサイズ（例: `_c.png`）が存在する場合のみ合成する。存在しないサイズは合成しない。

#### 1.3.3 高度な画像処理

*   **AI背景除去 (On-Demand):**
    
    *   ライブラリ `rembg` を使用。
    *   機能ON時にモデル未所持の場合、サイズ確認ダイアログを出してからDL・ロードする。
*   **サムネイルキャッシュ:** 一覧表示用の軽量画像をメモリ（または一時領域）に生成し、描画パフォーマンスを確保する。

#### 1.3.4 ファイル出力と安全性（堅牢化）

*   **パス自動解決 (Environment Validation):**
    
    *   アプリ起動時、Steamの構成ファイル (`libraryfolders.vdf`) を解析し、「Wizardry The Five Ordeals」のインストール先を自動検知する。
    *   自動検知に失敗した場合、ユーザーにゲーム実行ファイル (`WizardryFoV2.exe`) の選択を求める。
    *   特定された実行ファイルのパスから相対パス `Data/User/face` を算出し、これを出力先とする。
*   **アトミック保存:** いきなりファイルを上書きせず、「一時ファイル生成 → 成功確認 → 旧ファイル削除 → リネーム」の手順を厳守する。
*   **ロック回避:** 保存時に `PermissionError` (ゲームが使用中など) が発生した場合、即時クラッシュさせず、リトライを促すダイアログを表示する。
*   **クリーンアップ:** 保存処理開始時、フォルダ内の不要な `.png` を削除する（ゴーストファイル防止）。

#### 1.3.5 設定保存

*   **アプリ設定:** `app_config.json` に言語設定(JP/EN)、ウィンドウ位置、前回開いたパス（`last_open_path`）を保存。
*   **プロジェクトデータ:** 各Faceフォルダに `project_data.json` を保存。保存時は必ずバックアップ（`.bak`）を生成する。

# 2. 基本設計書 (Technical Design Document)

## 2.1 システムスタック

*   **Language:** Python 3.10.x
*   **GUI Framework:** CustomTkinter (>=5.2.0)
*   **Image Processing:** Pillow (>=10.0.0)
*   **AI Inference:** rembg (>=2.0.50), onnxruntime (CPU版推奨)
*   **Packaging:** PyInstaller (管理者権限マニフェスト付与)

## 2.2 ディレクトリ構造設計

### 2.2.1 アプリケーションルート

```
[AppRoot]
 ├── WFO_Portrait_Maker.exe
 ├── app_config.json          # アプリ全体設定
 ├── assets/
 │    ├── frames/             # フレーム画像 (.png)
 │    └── locales/            # 言語ファイル (en.json, jp.json)
 └── internal/                # 依存ライブラリ・モデル等


```

### 2.2.2 出力先データ構造 (Target Face Folder)

```
.../Data/User/face/face1/
 ├── project_data.json        # 現在の設定データ
 ├── project_data.json.bak    # ★バックアップ (Fail-safe)
 ├── sources/                 # ★隠しフォルダ推奨
 │    ├── {uuid4}.png         # 元画像 (ファイル名はUUID化して文字化け回避)
 │    └── ...
 ├── face_a.png               # ゲーム用出力画像
 ├── face_a_PO.png
 ...


```

## 2.3 データ定義 (JSON Schema)

### project\_data.json

```
{
  "version": "1.1",
  "display_name": "ユーザー入力名 (日本語可)",
  "uuid": "face-folder-unique-id",
  "face_center": {"x": 500, "y": 300},
  "frame_id": "frame_gold_01.png",
  "states": {
    "normal": {
      "source_uuid": "550e8400-e29b-...", // sourcesフォルダ内のファイルID
      "scale": 1.0,
      "offset_x": 0,
      "offset_y": 0,
      "use_rembg": false
    },
    "poison": {
      "source_uuid": "a1b2c3d4-...",
      "scale": 1.0,
      "offset_x": 0,
      "offset_y": 0,
      "use_rembg": true
    }
  }
}


```

## 2.4 主要クラス・モジュール設計

### 2.4.1 `FaceManager`

*   **責務:** データの整合性管理、安全なファイルI/O。
*   **メソッド `create_new_face(display_name)`:**
    
    *   `face1` から `face100` までループし、存在しないフォルダ名を特定して作成する。空きがない場合は `None` を返す。
*   **メソッド `import_images(file_paths)`:**
    
    *   複数ファイルパスを受け取り、リストへの一括登録を処理する。
    *   ファイル名の重複や順序を適切に処理し、UUIDを付与して保存する。
*   **メソッド `safe_export(face_data)`:**
    
    1.  **レンダリング:** メモリ上で `face_a` ～ `face_e` を生成。
    2.  **一時保存:** `face_a.tmp` として保存。
    3.  **検証:** ファイルが正しく生成されたか確認。
    4.  **スワップ:** `os.rename` 等でアトミックに置き換え。
    
    *   **例外処理:** プロセス中にエラーが発生した場合、`.tmp` を削除してロールバック。

### 2.4.2 `AsyncImageLoader`

*   **責務:** UIスレッドをブロックしない画像読み込み。
*   **仕様:** `ThreadPoolExecutor` 等を使用し、重い画像処理やI/Oを非同期化する。

### 2.4.3 `RembgWorker`

*   **責務:** 背景除去の実行とモデル管理。
*   **仕様:** `ImageProcessor` 内でセッションを遅延ロード（Lazy Load）し、スレッドセーフに管理する。

### 2.4.4 `SteamFinder` (実装済み新規クラス)

*   **責務:** Steamのインストール先およびゲームフォルダの自動検知。
*   **メソッド `find_game_executable(game_folder_name, preferred_exe_name)`:**
    
    1.  レジストリや標準パス（`C:\Program Files (x86)\Steam` 等）からSteamルートを特定。
    2.  `steamapps/libraryfolders.vdf` を正規表現で解析し、全てのSteamライブラリフォルダをリストアップする。
    3.  各ライブラリ内の `steamapps/common/{game_folder_name}` を走査する。
    4.  指定された `preferred_exe_name` (`WizardryFoV2.exe`) が存在すればそのパスを返す。

## 2.5 エラーハンドリング指針

1.  **PermissionError (WinError 32):**
    
    *   ゲームがファイルをロックしている場合、即時クラッシュさせない。
    *   `time.sleep(0.5)` で数回リトライ後、失敗した場合は「再試行 / キャンセル」ダイアログを表示する。
2.  **パス・文字コード:**
    
    *   内部処理（画像パス）には一貫してUUIDを使用する。

**End of Document**